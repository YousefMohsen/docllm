generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum FileType {
  EMAIL
  IMAGE
  OTHER
}

model File {
  id         Int      @id @default(autoincrement())
  path       String   @unique // relative to documents root, e.g. dataset-8/report.pdf
  type       FileType @default(OTHER)
  fullText   String   @map("full_text") @db.Text
  size       BigInt   // bytes
  pageCount  Int?     @map("page_count")
  summary    String?  @db.Text
  contentHash String? @map("content_hash") @db.VarChar(64) // optional, for change detection
  chunks         DocumentChunk[]
  entityMentions EntityMention[]

  @@map("files")
}

model DocumentChunk {
  id         Int      @id @default(autoincrement())
  fileId     Int      @map("file_id")
  chunkIndex Int      @map("chunk_index")
  content    String   @db.Text
  pageNumber Int?     @map("page_number")
  tokenCount Int?     @map("token_count")
  embedding  Unsupported("vector(1536)")? // pgvector, for semantic search

  file            File            @relation(fields: [fileId], references: [id], onDelete: Cascade)
  entityMentions  EntityMention[]

  @@unique([fileId, chunkIndex])
  @@index([fileId, chunkIndex])
  @@map("document_chunks")
}

model Entity {
  id   Int    @id @default(autoincrement())
  text String @db.Text // canonical form; not unique (name collisions allowed)
  type String @map("entity_type") @db.VarChar(20) // PERSON | LOCATION | ORGANIZATION

  variants EntityVariant[]
  mentions EntityMention[]

  @@index([type, text])
  @@map("entities")
}

model EntityVariant {
  id             Int    @id @default(autoincrement())
  entityId       Int    @map("entity_id")
  variantText    String @map("variant_text") @db.Text
  normalizedText String @map("normalized_text") @db.Text

  entity   Entity          @relation(fields: [entityId], references: [id], onDelete: Cascade)
  mentions EntityMention[]

  @@unique([entityId, normalizedText])
  @@index([entityId])
  @@map("entity_variants")
}

model EntityMention {
  id              Int     @id @default(autoincrement())
  fileId          Int     @map("file_id")
  chunkId         Int?    @map("chunk_id")
  entityId        Int     @map("entity_id")
  entityVariantId Int?    @map("entity_variant_id")
  mentionText     String? @map("mention_text") @db.Text
  pageNumber      Int?
  contextSnippet  String  @map("context_snippet") @db.Text

  file          File          @relation(fields: [fileId], references: [id], onDelete: Cascade)
  chunk         DocumentChunk? @relation(fields: [chunkId], references: [id], onDelete: SetNull)
  entity        Entity        @relation(fields: [entityId], references: [id], onDelete: Cascade)
  entityVariant EntityVariant? @relation(fields: [entityVariantId], references: [id], onDelete: SetNull)

  @@index([entityId, fileId])
  @@index([fileId, entityId])
  @@index([chunkId])
  @@map("entity_mentions")
}
